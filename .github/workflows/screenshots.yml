name: Screenshots

on:
  workflow_dispatch:
    inputs:
      devices:
        description: "Devices to capture (comma-separated)"
        required: false
        default: "iPhone 16 Pro Max,iPhone SE (3rd generation),iPad Pro 13-inch (M4)"
      language:
        description: "Language for screenshots"
        required: false
        default: "zh-Hans"
  schedule:
    # Every Monday at 09:00 UTC
    - cron: "0 9 * * 1"

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  screenshots:
    name: Capture Screenshots
    runs-on: macos-15
    strategy:
      matrix:
        device: ${{ fromJSON(format('["{0}"]', join(fromJSON(format('["{0}"]', inputs.devices || 'iPhone 16 Pro Max')), '","'))) }}

    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer

      - name: Boot Simulator
        run: |
          DEVICE_ID=$(xcrun simctl list devices available -j | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          for runtime, devices in data['devices'].items():
              for d in devices:
                  if '${{ matrix.device }}' in d['name']:
                      print(d['udid'])
                      sys.exit(0)
          sys.exit(1)
          ")
          xcrun simctl boot "$DEVICE_ID" || true
          echo "DEVICE_ID=$DEVICE_ID" >> $GITHUB_ENV

      - name: Build for Testing
        run: |
          xcodebuild build-for-testing \
            -project LeadSight.xcodeproj \
            -scheme LeadSight \
            -destination "platform=iOS Simulator,id=${{ env.DEVICE_ID }}" \
            -skipPackagePluginValidation \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty || true

      - name: Capture Screenshots
        run: |
          xcrun simctl io "${{ env.DEVICE_ID }}" screenshot screenshots/home.png
          echo "ðŸ“¸ Screenshots captured for ${{ matrix.device }}"

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.device }}
          path: screenshots/
          retention-days: 30
