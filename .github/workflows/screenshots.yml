name: Screenshots

on:
  workflow_dispatch:
    inputs:
      language:
        description: "Language for screenshots"
        required: false
        default: "zh-Hans"
  schedule:
    # Every Monday at 09:00 UTC
    - cron: "0 9 * * 1"

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  screenshots:
    name: Capture Screenshots
    runs-on: macos-15
    strategy:
      fail-fast: false
      matrix:
        device:
          - "iPhone 16 Pro Max"
          - "iPhone SE (3rd generation)"
          - "iPad Pro 13-inch (M4)"

    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer

      - name: Build for Simulator
        run: |
          xcodebuild build \
            -project LeadSight.xcodeproj \
            -scheme LeadSight \
            -destination 'platform=iOS Simulator,name=${{ matrix.device }},OS=latest' \
            -skipPackagePluginValidation \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty || true

      - name: Boot Simulator & Run App
        run: |
          DEVICE_UDID=$(xcrun simctl list devices available -j | python3 -c "
          import json, sys
          data = json.load(sys.stdin)
          target = '${{ matrix.device }}'
          for runtime, devices in data['devices'].items():
              if 'iOS' not in runtime:
                  continue
              for d in devices:
                  if d['name'] == target:
                      print(d['udid'])
                      sys.exit(0)
          sys.exit(1)
          ")
          
          echo "Booting simulator $DEVICE_UDID..."
          xcrun simctl boot "$DEVICE_UDID" 2>/dev/null || true
          sleep 3
          
          echo "Installing app..."
          xcrun simctl install "$DEVICE_UDID" \
            $(find ~/Library/Developer/Xcode/DerivedData -name "LeadSight.app" -type d | head -1)
          
          echo "Launching app..."
          xcrun simctl launch "$DEVICE_UDID" gandli.LeadSight
          
          echo "Waiting for app to load..."
          sleep 10
          
          mkdir -p screenshots
          xcrun simctl io "$DEVICE_UDID" screenshot "screenshots/${{ matrix.device }}.png"
          echo "Screenshot saved to screenshots/${{ matrix.device }}.png"

      - name: Upload Screenshots
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ matrix.device }}
          path: screenshots/
          retention-days: 30